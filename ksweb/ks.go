package main

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"ks/global"
	"ks/ksgift"
	"log"
	"net/http"
	"os"
	"time"

	"github.com/gorilla/websocket"
)

var ksgiftdata *ksgift.AutoGenerated

func main() {
	// go func() {
	// 	lunbo.Lunbo("å¤§è±¡çµé­‚çš„é»‘å¤œ")
	// }()

	// è·å–å¿«æ‰‹ç¤¼ç‰©æ•°æ®ï¼Œä¿å­˜åˆ°jsonæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨å°±å…ˆè¯»å–æ–‡ä»¶ï¼Œæ¯å¤©åˆ·æ–°ä¸€æ¬¡
	filename := "ksgifts.json"
	_, err := os.Stat(filename)

	if err == nil {
		// æ–‡ä»¶å­˜åœ¨ï¼Œå…ˆè¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®
		ksgiftdata, err = readDataFromFile(filename)
		if err != nil {
			fmt.Println("è¯»å–æ–‡ä»¶å¤±è´¥:", err)
			return
		}
	} else {
		// æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·å–æ•°æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶
		ksgiftdata, err := ksgift.Ksgift()
		if err != nil {
			fmt.Println("è·å–æ•°æ®å¤±è´¥:", err)
			return
		}
		saveDataToFile(ksgiftdata, filename)

	}

	// è®¾ç½® WebSocket è·¯ç”±
	http.HandleFunc("/ws", wsHandler)

	// å¯åŠ¨æœåŠ¡å™¨
	log.Println("æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8080...")
	err = http.ListenAndServe(":8080", nil)
	if err != nil {
		log.Fatal("æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:", err)
	}

	// æ¯å¤©åˆ·æ–°ä¸€æ¬¡æ•°æ®
	ticker := time.NewTicker(24 * time.Hour)
	for range ticker.C {
		ksgiftdata, err := ksgift.Ksgift()
		if err != nil {
			fmt.Println("è·å–æ•°æ®å¤±è´¥:", err)
			return
		}
		saveDataToFile(ksgiftdata, filename)
	}
}

// å¤„ç† WebSocket è¿æ¥
func wsHandler(w http.ResponseWriter, r *http.Request) {
	// å‡çº§ HTTP è¿æ¥ä¸º WebSocket
	conn, err := websocket.Upgrade(w, r, nil, 1024, 1024)
	if err != nil {
		log.Println(err)
		return
	}
	defer conn.Close()

	// è¯»å– JSON æ•°æ®
	_, msg, err := conn.ReadMessage()
	if err != nil {
		log.Println("è¯»å–æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:", err)
		return
	}

	// è§£æ JSON æ•°æ® å½“æ•°æ®æœªçŸ¥æ—¶ç›´æ¥æ‰“å°å‡ºæ¥
	// var data map[string]interface{}
	// err = json.Unmarshal(msg, &data)
	// if err != nil {
	// 	log.Println("è§£æ JSON æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:", err)
	// 	return
	// }
	// // å¤„ç†æ”¶åˆ°çš„æ•°æ®
	// fmt.Printf("æ”¶åˆ°æ¥è‡ª Python çš„æ¶ˆæ¯: %+v\n", data)

	data := &global.Message{}
	err = json.Unmarshal(msg, &data)
	if err != nil {
		log.Println("è§£æ JSON æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:", err)
		return
	}

	// å®æ—¶å¢é‡ä¿å­˜ data æ•°æ®åˆ° json æ–‡ä»¶
	err = SaveToFile(data, "message.json")
	if err != nil {
		log.Println("ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š", err)
	} else {
		log.Println("æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ–‡ä»¶")
	}
	// è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®
	messagetmp, err := ReadFromFile("message.json")
	if err != nil {
		log.Println("è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š", err)
	}
	messagetmp.DisplayLikeCount = data.DisplayLikeCount
	messagetmp.DisplayWatchingCount = data.DisplayWatchingCount
	messagetmp.GiftFeeds = append(messagetmp.GiftFeeds, data.GiftFeeds...)
	messagetmp.CommentFeeds = append(messagetmp.CommentFeeds, data.CommentFeeds...)
	messagetmp.LikeFeeds = append(messagetmp.LikeFeeds, data.LikeFeeds...)

	err = SaveToFile(messagetmp, "message.json")
	if err != nil {
		log.Println("ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š", err)
	} else {
		log.Println("æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ–‡ä»¶")
	}

	global.SetMessage(*data)

	if data.CommentFeeds != nil {
		for _, m := range data.CommentFeeds {
			fmt.Printf("[ğŸ“§ç›´æ’­é—´å¼¹å¹•æ¶ˆæ¯][%v]è¯´:%v\n", m.User.UserName, m.Content)
		}
	}
	if data.GiftFeeds != nil {
		for _, m := range data.GiftFeeds {
			giftname := ksgiftdata.Data[fmt.Sprintf("%v", m.GiftID)].GiftName
			if giftname == "" {
				giftname = "æœªçŸ¥ç¤¼ç‰©"
			}
			fmt.Printf("[ğŸç›´æ’­é—´ç¤¼ç‰©æ¶ˆæ¯]%vèµ é€ç¤¼ç‰©Id=%v è¿å‡»æ•°=%v\n", m.User.UserName, giftname, m.ComboCount)
		}
	}
	if data.LikeFeeds != nil {
		for _, m := range data.LikeFeeds {
			fmt.Printf("%vç‚¹èµäº†\n", m.User.UserName)
		}
	}
	if data.DisplayLikeCount != "" {
		fmt.Printf("æ€»å…±æœ‰ %v ä¸ªç‚¹èµ\n", data.DisplayLikeCount)
	}
	if data.DisplayWatchingCount != "" {
		fmt.Printf("æ€»å…±æœ‰ %v ä¸ªè§‚çœ‹\n", data.DisplayWatchingCount)
	}
}

func saveDataToFile(data *ksgift.AutoGenerated, filename string) error {
	// å°†æ•°æ®è½¬æ¢ä¸ºJSONæ ¼å¼
	jsonData, err := json.Marshal(data)
	if err != nil {
		return err
	}

	// å†™å…¥æ–‡ä»¶
	err = ioutil.WriteFile(filename, jsonData, 0644)
	if err != nil {
		return err
	}

	fmt.Println("æ•°æ®å·²ä¿å­˜åˆ°æ–‡ä»¶:", filename)
	return nil
}

func readDataFromFile(filename string) (*ksgift.AutoGenerated, error) {
	// è¯»å–æ–‡ä»¶å†…å®¹
	fileData, err := ioutil.ReadFile(filename)
	if err != nil {
		return nil, err
	}

	// è§£æJSONæ•°æ®
	var data ksgift.AutoGenerated
	err = json.Unmarshal(fileData, &data)
	if err != nil {
		return nil, err
	}

	return &data, nil
}

func ReadFromFile(filename string) (*global.Message, error) {
	// ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®
	content, err := ioutil.ReadFile(filename)
	if err != nil {
		return nil, err
	}

	// è§£æ JSON æ•°æ®
	data := &global.Message{}
	err = json.Unmarshal(content, &data)
	if err != nil {
		return nil, err
	}

	return data, nil
}

func SaveToFile(data *global.Message, filename string) error {
	// å°†æ•°æ®åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²
	jsonData, err := json.MarshalIndent(data, "", "  ")
	if err != nil {
		return err
	}

	// ä¿å­˜JSONæ•°æ®åˆ°æ–‡ä»¶
	err = ioutil.WriteFile(filename, jsonData, 0644)
	if err != nil {
		return err
	}

	return nil
}
